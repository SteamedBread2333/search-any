<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê†ºÂºèËΩ¨Êç¢Â∑•ÂéÇ - FFmpeg.wasm</title>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --error-color: #ea4335;
            --warning-color: #fbbc04;
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: var(--primary-color);
            background: rgba(66, 133, 244, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #3367d6;
        }

        .file-info {
            display: none;
            background: #e8f5e8;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-detail {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .file-detail-label {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .file-detail-value {
            color: var(--primary-color);
            font-weight: 500;
        }

        .conversion-section {
            display: none;
            margin-top: 30px;
        }

        .format-selector {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
        }

        .format-group {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .format-group h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            text-align: center;
        }

        .format-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .arrow {
            font-size: 2rem;
            color: var(--primary-color);
            text-align: center;
        }

        .options-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .option-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .option-group input,
        .option-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .convert-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .convert-btn:hover {
            background: #2d8f3f;
        }

        .convert-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .log-section {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .result-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .download-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s ease;
        }

        .download-btn:hover {
            background: #2d8f3f;
        }

        .supported-formats {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .supported-formats h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .format-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .format-category {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .format-category h4 {
            margin-bottom: 15px;
            color: var(--primary-color);
            text-align: center;
        }

        .format-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .format-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .error-message {
            background: #ffebee;
            color: var(--error-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .format-selector {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .arrow {
                transform: rotate(90deg);
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">‚Üê ËøîÂõûÈ¶ñÈ°µ</a>
            <h1>üîÑ Ê†ºÂºèËΩ¨Êç¢Â∑•ÂéÇ</h1>
            <p>Âü∫‰∫é FFmpeg.wasm ÁöÑÂº∫Â§ßÂ™í‰ΩìÊ†ºÂºèËΩ¨Êç¢Â∑•ÂÖ∑</p>
        </div>

        <div class="main-content">
            <!-- ÁΩëÁªúÊèêÁ§∫ -->
            <div class="network-notice" id="networkNotice" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                    <div>
                        <strong>ÁΩëÁªúÊèêÁ§∫</strong><br>
                        <span style="font-size: 0.9rem; color: #856404;">FFmpeg Ê†∏ÂøÉÊñá‰ª∂Á∫¶ 31MBÔºåÂª∫ËÆÆÂú®Á®≥ÂÆöÁΩëÁªúÁéØÂ¢É‰∏ã‰ΩøÁî®„ÄÇÈ¶ñÊ¨°Âä†ËΩΩÂèØËÉΩÈúÄË¶Å1-3ÂàÜÈíü„ÄÇ</span>
                    </div>
                </div>
            </div>

            <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">ÊãñÊîæÊñá‰ª∂Âà∞ËøôÈáåÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ÈÄâÊã©Êñá‰ª∂</button>
                <input type="file" id="fileInput" class="file-input" accept="*/*">
                <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                    <span id="preloadBtn" style="color: #4285f4; cursor: pointer; text-decoration: underline;" onclick="preloadFFmpeg()">
                        ÁÇπÂáªÈ¢ÑÂä†ËΩΩ FFmpeg (Êé®Ëçê)
                    </span>
                </div>
            </div>

            <!-- Êñá‰ª∂‰ø°ÊÅØ -->
            <div class="file-info" id="fileInfo">
                <div class="file-details" id="fileDetails"></div>
            </div>

            <!-- ÈîôËØØ‰ø°ÊÅØ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- ËΩ¨Êç¢ËÆæÁΩÆ -->
            <div class="conversion-section" id="conversionSection">
                <div class="format-selector">
                    <div class="format-group">
                        <h3>Ê∫êÊ†ºÂºè</h3>
                        <select class="format-select" id="sourceFormat" disabled>
                            <option value="">Ëá™Âä®Ê£ÄÊµã</option>
                        </select>
                    </div>
                    <div class="arrow">‚Üí</div>
                    <div class="format-group">
                        <h3>ÁõÆÊ†áÊ†ºÂºè</h3>
                        <select class="format-select" id="targetFormat">
                            <option value="">ËØ∑ÈÄâÊã©Ê†ºÂºè</option>
                        </select>
                    </div>
                </div>

                <!-- ËΩ¨Êç¢ÈÄâÈ°π -->
                <div class="options-section">
                    <h3 style="text-align: center; margin-bottom: 20px;">ËΩ¨Êç¢ÈÄâÈ°π</h3>
                    <div class="options-grid">
                        <div class="option-group">
                            <label for="quality">Ë¥®Èáè</label>
                            <select id="quality">
                                <option value="high">È´òË¥®Èáè</option>
                                <option value="medium" selected>‰∏≠Á≠âË¥®Èáè</option>
                                <option value="low">‰ΩéË¥®Èáè</option>
                                <option value="custom">Ëá™ÂÆö‰πâ</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label for="bitrate">ÊØîÁâπÁéá (kbps)</label>
                            <input type="number" id="bitrate" placeholder="Ëá™Âä®" min="64" max="10000">
                        </div>
                        <div class="option-group">
                            <label for="resolution">ÂàÜËæ®Áéá</label>
                            <select id="resolution">
                                <option value="">‰øùÊåÅÂéüÂßã</option>
                                <option value="1920x1080">1080p (1920x1080)</option>
                                <option value="1280x720">720p (1280x720)</option>
                                <option value="854x480">480p (854x480)</option>
                                <option value="640x360">360p (640x360)</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label for="fps">Â∏ßÁéá</label>
                            <select id="fps">
                                <option value="">‰øùÊåÅÂéüÂßã</option>
                                <option value="60">60 FPS</option>
                                <option value="30">30 FPS</option>
                                <option value="24">24 FPS</option>
                                <option value="15">15 FPS</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="convert-btn" id="convertBtn" onclick="startConversion()">ÂºÄÂßãËΩ¨Êç¢</button>
            </div>

            <!-- ËøõÂ∫¶ÊòæÁ§∫ -->
            <div class="progress-section" id="progressSection">
                <div class="progress-text" id="progressText">ÂáÜÂ§á‰∏≠...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="log-section" id="logSection"></div>
            </div>

            <!-- ÁªìÊûú‰∏ãËΩΩ -->
            <div class="result-section" id="resultSection">
                <h3>ËΩ¨Êç¢ÂÆåÊàêÔºÅ</h3>
                <a href="#" class="download-btn" id="downloadBtn" download>‰∏ãËΩΩÊñá‰ª∂</a>
            </div>

            <!-- ÊîØÊåÅÁöÑÊ†ºÂºè -->
            <div class="supported-formats">
                <h3>ÊîØÊåÅÁöÑÊ†ºÂºè</h3>
                <div class="format-categories" id="formatCategories">
                    <!-- Ê†ºÂºèÂàóË°®Â∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <script>
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile, toBlobURL } = FFmpegUtil;

        let ffmpeg = null;
        let currentFile = null;
        let isFFmpegLoaded = false;

        // ÊîØÊåÅÁöÑÊ†ºÂºèÈÖçÁΩÆ
        const supportedFormats = {
            video: {
                name: 'ËßÜÈ¢ëÊ†ºÂºè',
                formats: ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv', 'm4v', '3gp', 'ogv', 'mpg', 'mpeg', 'ts', 'mts', 'm2ts']
            },
            audio: {
                name: 'Èü≥È¢ëÊ†ºÂºè',
                formats: ['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma', 'm4a', 'opus', 'ac3', 'dts', 'amr', 'aiff', 'au']
            },
            image: {
                name: 'ÂõæÁâáÊ†ºÂºè',
                formats: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp', 'ico', 'svg', 'psd', 'raw']
            },
            document: {
                name: 'ÊñáÊ°£Ê†ºÂºè',
                formats: ['pdf', 'txt', 'rtf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx']
            }
        };

        // ÂàùÂßãÂåñ
        async function init() {
            // Ê£ÄÊü•ÊµèËßàÂô®ÂÖºÂÆπÊÄß
            checkBrowserCompatibility();
            
            // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            checkNetworkStatus();
            
            setupEventListeners();
            renderSupportedFormats();
            populateFormatSelectors();
            
            // ËÆæÁΩÆÂàùÂßãÊåâÈíÆÁä∂ÊÄÅ
            updateConvertButton();
        }

        // È¢ÑÂä†ËΩΩ FFmpeg
        async function preloadFFmpeg() {
            const preloadBtn = document.getElementById('preloadBtn');
            preloadBtn.style.display = 'none';
            
            if (!isFFmpegLoaded) {
                await loadFFmpeg();
            } else {
                showSuccess('FFmpeg Â∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºÅ');
            }
        }

        // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
        function checkNetworkStatus() {
            // ÊòæÁ§∫ÁΩëÁªúÊèêÁ§∫
            document.getElementById('networkNotice').style.display = 'block';
            
            // Ê£ÄÊü•ÁΩëÁªúËøûÊé•Áä∂ÊÄÅ
            if ('connection' in navigator) {
                const connection = navigator.connection;
                const networkType = connection.effectiveType;
                
                if (networkType === 'slow-2g' || networkType === '2g') {
                    showError('Ê£ÄÊµãÂà∞ËæÉÊÖ¢ÁöÑÁΩëÁªúËøûÊé•ÔºåFFmpeg Âä†ËΩΩÂèØËÉΩÈúÄË¶ÅËæÉÈïøÊó∂Èó¥ÔºåÂª∫ËÆÆÂú® WiFi ÁéØÂ¢É‰∏ã‰ΩøÁî®„ÄÇ');
                } else if (networkType === '3g') {
                    console.warn('Ê£ÄÊµãÂà∞ 3G ÁΩëÁªúÔºåÂª∫ËÆÆËÄêÂøÉÁ≠âÂæÖÂä†ËΩΩÂÆåÊàê');
                }
            }
            
            // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅÂèòÂåñ
            window.addEventListener('online', () => {
                console.log('ÁΩëÁªúÂ∑≤ËøûÊé•');
                hideError();
            });
            
            window.addEventListener('offline', () => {
                showError('ÁΩëÁªúËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            });
        }

        // Ê£ÄÊü•ÊµèËßàÂô®ÂÖºÂÆπÊÄß
        function checkBrowserCompatibility() {
            // Ê£ÄÊü• WebAssembly ÊîØÊåÅ
            if (typeof WebAssembly === 'undefined') {
                showError('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅ WebAssemblyÔºåÊó†Ê≥ï‰ΩøÁî®Ê≠§Â∑•ÂÖ∑„ÄÇËØ∑ÂçáÁ∫ßÂà∞Áé∞‰ª£ÊµèËßàÂô®„ÄÇ');
                return false;
            }

            // Ê£ÄÊü• SharedArrayBuffer ÊîØÊåÅÔºàÁî®‰∫éÂ§öÁ∫øÁ®ãÔºâ
            if (typeof SharedArrayBuffer === 'undefined') {
                console.warn('SharedArrayBuffer ‰∏çÂèØÁî®ÔºåÂ∞Ü‰ΩøÁî®ÂçïÁ∫øÁ®ãÊ®°Âºè');
                // Ëøô‰∏çÊòØËá¥ÂëΩÈîôËØØÔºåÂè™ÊòØÊÄßËÉΩ‰ºöÂ∑Æ‰∏Ä‰∫õ
            }

            // Ê£ÄÊü•ÂøÖË¶ÅÁöÑ API
            if (!window.fetch || !window.URL || !window.Blob) {
                showError('ÊÇ®ÁöÑÊµèËßàÂô®Áº∫Â∞ëÂøÖË¶ÅÁöÑ API ÊîØÊåÅÔºåËØ∑ÂçáÁ∫ßÊµèËßàÂô®„ÄÇ');
                return false;
            }

            return true;
        }

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            const uploadSection = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');

            // ÊãñÊãΩ‰∏ä‰º†
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // Êñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // Ê†ºÂºèÈÄâÊã©ÂèòÂåñ
            document.getElementById('targetFormat').addEventListener('change', updateConversionOptions);
        }

        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
        async function handleFileSelect(file) {
            currentFile = file;
            
            // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
            displayFileInfo(file);
            
            // Ê£ÄÊµãÊñá‰ª∂Ê†ºÂºè
            const detectedFormat = detectFileFormat(file.name);
            if (detectedFormat) {
                document.getElementById('sourceFormat').value = detectedFormat;
            }
            
            // ÊòæÁ§∫ËΩ¨Êç¢ÈÄâÈ°π
            document.getElementById('conversionSection').style.display = 'block';
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateConvertButton();
            
            // Á°Æ‰øù FFmpeg Â∑≤Âä†ËΩΩ
            if (!isFFmpegLoaded) {
                await loadFFmpeg();
            }
        }

        // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            const lastModified = new Date(file.lastModified).toLocaleString();
            
            fileDetails.innerHTML = `
                <div class="file-detail">
                    <div class="file-detail-label">Êñá‰ª∂Âêç</div>
                    <div class="file-detail-value">${file.name}</div>
                </div>
                <div class="file-detail">
                    <div class="file-detail-label">Êñá‰ª∂Â§ßÂ∞è</div>
                    <div class="file-detail-value">${sizeInMB} MB</div>
                </div>
                <div class="file-detail">
                    <div class="file-detail-label">Êñá‰ª∂Á±ªÂûã</div>
                    <div class="file-detail-value">${file.type || 'Êú™Áü•'}</div>
                </div>
                <div class="file-detail">
                    <div class="file-detail-label">‰øÆÊîπÊó∂Èó¥</div>
                    <div class="file-detail-value">${lastModified}</div>
                </div>
            `;
            
            fileInfo.style.display = 'block';
        }

        // Ê£ÄÊµãÊñá‰ª∂Ê†ºÂºè
        function detectFileFormat(filename) {
            const extension = filename.toLowerCase().split('.').pop();
            return extension;
        }

        // Âä†ËΩΩ FFmpeg
        async function loadFFmpeg() {
            try {
                showProgress('Ê≠£Âú®Âä†ËΩΩ FFmpeg Ê†∏ÂøÉÊñá‰ª∂ (~31MB)...', 0);
                
                ffmpeg = new FFmpeg();
                
                ffmpeg.on('log', ({ message }) => {
                    console.log(message);
                    appendLog(message);
                });
                
                ffmpeg.on('progress', ({ progress, time }) => {
                    const percentage = Math.round(progress * 100);
                    updateProgress(`ËΩ¨Êç¢‰∏≠... ${percentage}%`, percentage);
                });

                // ‰ΩøÁî®ÈáçËØïÊú∫Âà∂Âä†ËΩΩÂ§ßÊñá‰ª∂
                await loadWithRetry();
                
                isFFmpegLoaded = true;
                hideProgress();
                updateConvertButton();
                showSuccess('FFmpeg Âä†ËΩΩÂÆåÊàêÔºÅ');
            } catch (error) {
                console.error('FFmpeg Âä†ËΩΩÂ§±Ë¥•:', error);
                showError('FFmpeg Âä†ËΩΩÂ§±Ë¥•: ' + error.message + ' - Ê≠£Âú®Â∞ùËØïÂ§áÁî®ÊñπÊ°à...');
                
                // Â∞ùËØïÂ§áÁî®Âä†ËΩΩÊñπÊ°à
                try {
                    await loadFFmpegFallback();
                    // Á°Æ‰øùÁä∂ÊÄÅÊ≠£Á°ÆÊõ¥Êñ∞
                    isFFmpegLoaded = true;
                    hideProgress();
                    updateConvertButton();
                    showSuccess('FFmpeg Âä†ËΩΩÂÆåÊàêÔºàÂ§áÁî®ÊñπÊ°àÔºâÔºÅ');
                } catch (fallbackError) {
                    console.error('Â§áÁî®ÊñπÊ°à‰πüÂ§±Ë¥•:', fallbackError);
                    isFFmpegLoaded = false;
                    hideProgress();
                    showError('FFmpeg Âä†ËΩΩÂ§±Ë¥•ÔºåÊñá‰ª∂ËæÉÂ§ß(31MB)ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï„ÄÇÂª∫ËÆÆ‰ΩøÁî®Á®≥ÂÆöÁöÑÁΩëÁªúÁéØÂ¢É„ÄÇ');
                }
            }
        }

        // Â∏¶ÈáçËØïÁöÑÂä†ËΩΩÂáΩÊï∞
        async function loadWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    updateProgress(`Ê≠£Âú®Âä†ËΩΩ FFmpeg (Â∞ùËØï ${attempt}/${maxRetries})...`, (attempt - 1) * 10);
                    
                    const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
                    
                    // ‰ΩøÁî®Ë∂ÖÊó∂ÊéßÂà∂
                    const loadPromise = ffmpeg.load({
                        coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                        wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                    });
                    
                    // ËÆæÁΩÆË∂ÖÊó∂ (60Áßí)
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Âä†ËΩΩË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•')), 60000);
                    });
                    
                    await Promise.race([loadPromise, timeoutPromise]);
                    
                    // Â¶ÇÊûúÊàêÂäüÔºåË∑≥Âá∫ÈáçËØïÂæ™ÁéØ
                    console.log(`FFmpeg Âä†ËΩΩÊàêÂäü (Â∞ùËØï ${attempt})`);
                    return;
                    
                } catch (error) {
                    console.warn(`Âä†ËΩΩÂ∞ùËØï ${attempt} Â§±Ë¥•:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Á≠âÂæÖÂêéÈáçËØï
                    updateProgress(`Âä†ËΩΩÂ§±Ë¥•Ôºå${2}ÁßíÂêéÈáçËØï...`, attempt * 20);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        // Â§áÁî®Âä†ËΩΩÊñπÊ°à
        async function loadFFmpegFallback() {
            showProgress('Ê≠£Âú®Â∞ùËØïÂ§áÁî®Âä†ËΩΩÊñπÊ°à...', 0);
            
            // Â∞ùËØïÂ§ö‰∏™ CDN Ê∫êÂíåÁâàÊú¨
            const cdnOptions = [
                {
                    name: 'jsDelivr CDN (0.12.6)',
                    url: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd',
                },
                {
                    name: 'unpkg CDN (0.12.4)',
                    url: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd',
                },
                {
                    name: 'jsDelivr CDN (0.12.4)', 
                    url: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/umd',
                },
                {
                    name: 'jsDelivr CDN (0.11.0 - ËΩªÈáèÁâà)',
                    url: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/umd',
                }
            ];
            
            for (let i = 0; i < cdnOptions.length; i++) {
                try {
                    const option = cdnOptions[i];
                    showProgress(`Ê≠£Âú®Â∞ùËØï ${option.name} (${i + 1}/${cdnOptions.length})...`, (i / cdnOptions.length) * 80);
                    
                    // ‰∏∫ÊØè‰∏™CDN‰πüÊ∑ªÂä†Ë∂ÖÊó∂ÂíåÈáçËØï
                    await loadFromCDNWithTimeout(option.url, 45000); // 45ÁßíË∂ÖÊó∂
                    
                    console.log(`FFmpeg ÈÄöËøá ${option.name} Âä†ËΩΩÊàêÂäü`);
                    return;
                } catch (error) {
                    console.warn(`${cdnOptions[i].name} Â§±Ë¥•:`, error.message);
                    if (i === cdnOptions.length - 1) {
                        throw error;
                    }
                    
                    // Áü≠ÊöÇÁ≠âÂæÖÂêéÂ∞ùËØï‰∏ã‰∏Ä‰∏™CDN
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        // ‰ªéÊåáÂÆöCDNÂä†ËΩΩÔºåÂ∏¶Ë∂ÖÊó∂ÊéßÂà∂
        async function loadFromCDNWithTimeout(baseURL, timeout = 45000) {
            const loadPromise = ffmpeg.load({
                coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
            });
            
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error(`CDN Âä†ËΩΩË∂ÖÊó∂ (${timeout/1000}Áßí)`)), timeout);
            });
            
            return Promise.race([loadPromise, timeoutPromise]);
        }

        // Â°´ÂÖÖÊ†ºÂºèÈÄâÊã©Âô®
        function populateFormatSelectors() {
            const targetFormat = document.getElementById('targetFormat');
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            targetFormat.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ê†ºÂºè</option>';
            
            // Ê∑ªÂä†ÊâÄÊúâÊîØÊåÅÁöÑÊ†ºÂºè
            Object.values(supportedFormats).forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category.name;
                
                category.formats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format.toUpperCase();
                    optgroup.appendChild(option);
                });
                
                targetFormat.appendChild(optgroup);
            });
        }

        // Êõ¥Êñ∞ËΩ¨Êç¢ÈÄâÈ°π
        function updateConversionOptions() {
            const targetFormat = document.getElementById('targetFormat').value;
            const isVideo = supportedFormats.video.formats.includes(targetFormat);
            const isAudio = supportedFormats.audio.formats.includes(targetFormat);
            
            // Ê†πÊçÆÁõÆÊ†áÊ†ºÂºèÊòæÁ§∫/ÈöêËóèÁõ∏ÂÖ≥ÈÄâÈ°π
            document.getElementById('resolution').parentElement.style.display = isVideo ? 'block' : 'none';
            document.getElementById('fps').parentElement.style.display = isVideo ? 'block' : 'none';
            
            // Êõ¥Êñ∞ËΩ¨Êç¢ÊåâÈíÆÁä∂ÊÄÅ
            updateConvertButton();
        }

        // Êõ¥Êñ∞ËΩ¨Êç¢ÊåâÈíÆÁä∂ÊÄÅ
        function updateConvertButton() {
            const convertBtn = document.getElementById('convertBtn');
            const hasFile = !!currentFile;
            const hasTargetFormat = !!document.getElementById('targetFormat').value;
            const canConvert = hasFile && isFFmpegLoaded && hasTargetFormat;
            
            convertBtn.disabled = !canConvert;
            
            if (!hasFile) {
                convertBtn.textContent = 'ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂';
            } else if (!isFFmpegLoaded) {
                convertBtn.textContent = 'FFmpeg Âä†ËΩΩ‰∏≠...';
            } else if (!hasTargetFormat) {
                convertBtn.textContent = 'ËØ∑ÈÄâÊã©ÁõÆÊ†áÊ†ºÂºè';
            } else {
                convertBtn.textContent = 'ÂºÄÂßãËΩ¨Êç¢';
            }
            
            console.log('ÊåâÈíÆÁä∂ÊÄÅÊõ¥Êñ∞:', { hasFile, isFFmpegLoaded, hasTargetFormat, canConvert });
        }

        // ÂºÄÂßãËΩ¨Êç¢
        async function startConversion() {
            console.log('ÂºÄÂßãËΩ¨Êç¢Ê£ÄÊü•:', { 
                hasFile: !!currentFile, 
                isLoaded: isFFmpegLoaded, 
                ffmpegInstance: !!ffmpeg 
            });
            
            if (!currentFile) {
                showError('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂');
                return;
            }
            
            if (!isFFmpegLoaded) {
                showError('FFmpeg Â∞öÊú™Âä†ËΩΩÂÆåÊàêÔºåËØ∑Á®çÂÄô...');
                // Â¶ÇÊûúËøòÊ≤°Âä†ËΩΩÔºåÂ∞ùËØïÂä†ËΩΩ
                if (!ffmpeg) {
                    await loadFFmpeg();
                }
                return;
            }
            
            const targetFormat = document.getElementById('targetFormat').value;
            if (!targetFormat) {
                showError('ËØ∑ÈÄâÊã©ÁõÆÊ†áÊ†ºÂºè');
                return;
            }
            
            try {
                // Á¶ÅÁî®ËΩ¨Êç¢ÊåâÈíÆ
                document.getElementById('convertBtn').disabled = true;
                
                // ÊòæÁ§∫ËøõÂ∫¶
                showProgress('Ê≠£Âú®ÂáÜÂ§áËΩ¨Êç¢...', 0);
                
                // ÂÜôÂÖ•ËæìÂÖ•Êñá‰ª∂
                const inputFileName = `input.${detectFileFormat(currentFile.name)}`;
                const outputFileName = `output.${targetFormat}`;
                
                await ffmpeg.writeFile(inputFileName, await fetchFile(currentFile));
                
                // ÊûÑÂª∫ FFmpeg ÂëΩ‰ª§
                const command = buildFFmpegCommand(inputFileName, outputFileName);
                
                showProgress('Ê≠£Âú®ËΩ¨Êç¢Êñá‰ª∂...', 10);
                
                // ÊâßË°åËΩ¨Êç¢
                await ffmpeg.exec(command);
                
                // ËØªÂèñËæìÂá∫Êñá‰ª∂
                const data = await ffmpeg.readFile(outputFileName);
                
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const blob = new Blob([data.buffer], { type: getMimeType(targetFormat) });
                const url = URL.createObjectURL(blob);
                
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = url;
                downloadBtn.download = `converted.${targetFormat}`;
                
                // ÊòæÁ§∫ÁªìÊûú
                hideProgress();
                document.getElementById('resultSection').style.display = 'block';
                showSuccess('ËΩ¨Êç¢ÂÆåÊàêÔºÅ');
                
            } catch (error) {
                console.error('ËΩ¨Êç¢Â§±Ë¥•:', error);
                showError('ËΩ¨Êç¢Â§±Ë¥•: ' + error.message);
                hideProgress();
            } finally {
                document.getElementById('convertBtn').disabled = false;
            }
        }

        // ÊûÑÂª∫ FFmpeg ÂëΩ‰ª§
        function buildFFmpegCommand(inputFile, outputFile) {
            const command = ['-i', inputFile];
            
            // Ë¥®ÈáèËÆæÁΩÆ
            const quality = document.getElementById('quality').value;
            const bitrate = document.getElementById('bitrate').value;
            const resolution = document.getElementById('resolution').value;
            const fps = document.getElementById('fps').value;
            
            // Ê∑ªÂä†Ë¥®ÈáèÂèÇÊï∞
            if (quality === 'high') {
                command.push('-crf', '18');
            } else if (quality === 'medium') {
                command.push('-crf', '23');
            } else if (quality === 'low') {
                command.push('-crf', '28');
            }
            
            // Ê∑ªÂä†ÊØîÁâπÁéá
            if (bitrate) {
                command.push('-b:v', `${bitrate}k`);
            }
            
            // Ê∑ªÂä†ÂàÜËæ®Áéá
            if (resolution) {
                command.push('-s', resolution);
            }
            
            // Ê∑ªÂä†Â∏ßÁéá
            if (fps) {
                command.push('-r', fps);
            }
            
            // ËæìÂá∫Êñá‰ª∂
            command.push(outputFile);
            
            return command;
        }

        // Ëé∑Âèñ MIME Á±ªÂûã
        function getMimeType(format) {
            const mimeTypes = {
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'avi': 'video/avi',
                'mov': 'video/quicktime',
                'mp3': 'audio/mpeg',
                'wav': 'audio/wav',
                'ogg': 'audio/ogg',
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'webp': 'image/webp'
            };
            return mimeTypes[format] || 'application/octet-stream';
        }

        // Ê∏≤ÊüìÊîØÊåÅÁöÑÊ†ºÂºè
        function renderSupportedFormats() {
            const container = document.getElementById('formatCategories');
            
            Object.values(supportedFormats).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'format-category';
                
                const title = document.createElement('h4');
                title.textContent = category.name;
                categoryDiv.appendChild(title);
                
                const formatList = document.createElement('div');
                formatList.className = 'format-list';
                
                category.formats.forEach(format => {
                    const tag = document.createElement('span');
                    tag.className = 'format-tag';
                    tag.textContent = format.toUpperCase();
                    formatList.appendChild(tag);
                });
                
                categoryDiv.appendChild(formatList);
                container.appendChild(categoryDiv);
            });
        }

        // ËøõÂ∫¶ÂíåÁä∂ÊÄÅÊòæÁ§∫ÂáΩÊï∞
        function showProgress(text, percentage) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('logSection').style.display = 'block';
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function updateProgress(text, percentage) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
        }

        function showSuccess(message) {
            // ÂèØ‰ª•Ê∑ªÂä†ÊàêÂäüÊèêÁ§∫ÁöÑÂÆûÁé∞
            console.log('Success:', message);
        }

        function appendLog(message) {
            const logSection = document.getElementById('logSection');
            logSection.textContent += message + '\n';
            logSection.scrollTop = logSection.scrollHeight;
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        init();
    </script>
</body>
</html> 