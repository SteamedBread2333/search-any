<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¼å¼è½¬æ¢å·¥å‚ - FFmpeg.wasm</title>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --error-color: #ea4335;
            --warning-color: #fbbc04;
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: var(--primary-color);
            background: rgba(66, 133, 244, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #3367d6;
        }

        .file-info {
            display: none;
            background: #e8f5e8;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-detail {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .file-detail-label {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .file-detail-value {
            color: var(--primary-color);
            font-weight: 500;
        }

        .conversion-section {
            display: none;
            margin-top: 30px;
        }

        .format-selector {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
        }

        .format-group {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .format-group h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            text-align: center;
        }

        .format-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .arrow {
            font-size: 2rem;
            color: var(--primary-color);
            text-align: center;
        }

        .options-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .option-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .option-group input,
        .option-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .convert-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .convert-btn:hover {
            background: #2d8f3f;
        }

        .convert-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .log-section {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .result-section {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .download-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s ease;
        }

        .download-btn:hover {
            background: #2d8f3f;
        }

        .supported-formats {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .supported-formats h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .format-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .format-category {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .format-category h4 {
            margin-bottom: 15px;
            color: var(--primary-color);
            text-align: center;
        }

        .format-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .format-tag {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .error-message {
            background: #ffebee;
            color: var(--error-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .format-selector {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .arrow {
                transform: rotate(90deg);
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸ”„ æ ¼å¼è½¬æ¢å·¥å‚</h1>
            <p>åŸºäº FFmpeg.wasm çš„å¼ºå¤§åª’ä½“æ ¼å¼è½¬æ¢å·¥å…·</p>
        </div>

        <div class="main-content">
            <!-- ç½‘ç»œæç¤º -->
            <div class="network-notice" id="networkNotice" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5rem;">âš ï¸</span>
                    <div>
                        <strong>ç½‘ç»œæç¤º</strong><br>
                        <span style="font-size: 0.9rem; color: #856404;">FFmpeg æ ¸å¿ƒæ–‡ä»¶çº¦ 31MBï¼Œå»ºè®®åœ¨ç¨³å®šç½‘ç»œç¯å¢ƒä¸‹ä½¿ç”¨ã€‚é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦1-3åˆ†é’Ÿã€‚</span>
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                <input type="file" id="fileInput" class="file-input" accept="*/*">
                <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                    <span id="preloadBtn" style="color: #4285f4; cursor: pointer; text-decoration: underline;" onclick="preloadFFmpeg()">
                        ç‚¹å‡»é¢„åŠ è½½ FFmpeg (æ¨è)
                    </span>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¿¡æ¯ -->
            <div class="file-info" id="fileInfo">
                <div class="file-details" id="fileDetails"></div>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- è½¬æ¢è®¾ç½® -->
            <div class="conversion-section" id="conversionSection">
                <div class="format-selector">
                    <div class="format-group">
                        <h3>æºæ ¼å¼</h3>
                        <select class="format-select" id="sourceFormat" disabled>
                            <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                        </select>
                    </div>
                    <div class="arrow">â†’</div>
                    <div class="format-group">
                        <h3>ç›®æ ‡æ ¼å¼</h3>
                        <select class="format-select" id="targetFormat">
                            <option value="">è¯·é€‰æ‹©æ ¼å¼</option>
                        </select>
                    </div>
                </div>

                <!-- è½¬æ¢é€‰é¡¹ -->
                <div class="options-section">
                    <h3 style="text-align: center; margin-bottom: 20px;">è½¬æ¢é€‰é¡¹</h3>
                    <div class="options-grid">
                        <div class="option-group">
                            <label for="quality">è´¨é‡</label>
                            <select id="quality">
                                <option value="high">é«˜è´¨é‡</option>
                                <option value="medium" selected>ä¸­ç­‰è´¨é‡</option>
                                <option value="low">ä½è´¨é‡</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label for="bitrate">æ¯”ç‰¹ç‡ (kbps)</label>
                            <input type="number" id="bitrate" placeholder="è‡ªåŠ¨" min="64" max="10000">
                        </div>
                        <div class="option-group">
                            <label for="resolution">åˆ†è¾¨ç‡</label>
                            <select id="resolution">
                                <option value="">ä¿æŒåŸå§‹</option>
                                <option value="1920x1080">1080p (1920x1080)</option>
                                <option value="1280x720">720p (1280x720)</option>
                                <option value="854x480">480p (854x480)</option>
                                <option value="640x360">360p (640x360)</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label for="fps">å¸§ç‡</label>
                            <select id="fps">
                                <option value="">ä¿æŒåŸå§‹</option>
                                <option value="60">60 FPS</option>
                                <option value="30">30 FPS</option>
                                <option value="24">24 FPS</option>
                                <option value="15">15 FPS</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="convert-btn" id="convertBtn" onclick="startConversion()">å¼€å§‹è½¬æ¢</button>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="progress-section" id="progressSection">
                <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="log-section" id="logSection"></div>
            </div>

            <!-- ç»“æœä¸‹è½½ -->
            <div class="result-section" id="resultSection">
                <h3>è½¬æ¢å®Œæˆï¼</h3>
                <a href="#" class="download-btn" id="downloadBtn" download>ä¸‹è½½æ–‡ä»¶</a>
            </div>

            <!-- æ”¯æŒçš„æ ¼å¼ -->
            <div class="supported-formats">
                <h3>æ”¯æŒçš„æ ¼å¼</h3>
                <div class="format-categories" id="formatCategories">
                    <!-- æ ¼å¼åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <script>
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile, toBlobURL } = FFmpegUtil;

        let ffmpeg = null;
        let currentFile = null;
        let isFFmpegLoaded = false;

        // æ”¯æŒçš„æ ¼å¼é…ç½®
        const supportedFormats = {
            video: {
                name: 'è§†é¢‘æ ¼å¼',
                formats: ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv', 'm4v', '3gp', 'ogv', 'mpg', 'mpeg', 'ts', 'mts', 'm2ts']
            },
            audio: {
                name: 'éŸ³é¢‘æ ¼å¼',
                formats: ['mp3', 'wav', 'flac', 'aac', 'ogg', 'wma', 'm4a', 'opus', 'ac3', 'dts', 'amr', 'aiff', 'au']
            },
            image: {
                name: 'å›¾ç‰‡æ ¼å¼',
                formats: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp', 'ico', 'svg', 'psd', 'raw']
            },
            document: {
                name: 'æ–‡æ¡£æ ¼å¼',
                formats: ['pdf', 'txt', 'rtf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx']
            }
        };

        // åˆå§‹åŒ–
        async function init() {
            // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            checkBrowserCompatibility();
            
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            checkNetworkStatus();
            
            setupEventListeners();
            renderSupportedFormats();
            populateFormatSelectors();
            
            // è®¾ç½®åˆå§‹æŒ‰é’®çŠ¶æ€
            updateConvertButton();
        }

        // é¢„åŠ è½½ FFmpeg
        async function preloadFFmpeg() {
            const preloadBtn = document.getElementById('preloadBtn');
            preloadBtn.style.display = 'none';
            
            if (!isFFmpegLoaded) {
                await loadFFmpeg();
            } else {
                showSuccess('FFmpeg å·²ç»åŠ è½½å®Œæˆï¼');
            }
        }

        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        function checkNetworkStatus() {
            // æ˜¾ç¤ºç½‘ç»œæç¤º
            document.getElementById('networkNotice').style.display = 'block';
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
            if ('connection' in navigator) {
                const connection = navigator.connection;
                const networkType = connection.effectiveType;
                
                if (networkType === 'slow-2g' || networkType === '2g') {
                    showError('æ£€æµ‹åˆ°è¾ƒæ…¢çš„ç½‘ç»œè¿æ¥ï¼ŒFFmpeg åŠ è½½å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå»ºè®®åœ¨ WiFi ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚');
                } else if (networkType === '3g') {
                    console.warn('æ£€æµ‹åˆ° 3G ç½‘ç»œï¼Œå»ºè®®è€å¿ƒç­‰å¾…åŠ è½½å®Œæˆ');
                }
            }
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', () => {
                console.log('ç½‘ç»œå·²è¿æ¥');
                hideError();
            });
            
            window.addEventListener('offline', () => {
                showError('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkBrowserCompatibility() {
            // æ£€æŸ¥ WebAssembly æ”¯æŒ
            if (typeof WebAssembly === 'undefined') {
                showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebAssemblyï¼Œæ— æ³•ä½¿ç”¨æ­¤å·¥å…·ã€‚è¯·å‡çº§åˆ°ç°ä»£æµè§ˆå™¨ã€‚');
                return false;
            }

            // æ£€æŸ¥ SharedArrayBuffer æ”¯æŒï¼ˆç”¨äºå¤šçº¿ç¨‹ï¼‰
            if (typeof SharedArrayBuffer === 'undefined') {
                console.warn('SharedArrayBuffer ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼');
                // è¿™ä¸æ˜¯è‡´å‘½é”™è¯¯ï¼Œåªæ˜¯æ€§èƒ½ä¼šå·®ä¸€äº›
            }

            // æ£€æŸ¥å¿…è¦çš„ API
            if (!window.fetch || !window.URL || !window.Blob) {
                showError('æ‚¨çš„æµè§ˆå™¨ç¼ºå°‘å¿…è¦çš„ API æ”¯æŒï¼Œè¯·å‡çº§æµè§ˆå™¨ã€‚');
                return false;
            }

            return true;
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const uploadSection = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');

            // æ‹–æ‹½ä¸Šä¼ 
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // æ ¼å¼é€‰æ‹©å˜åŒ–
            document.getElementById('targetFormat').addEventListener('change', updateConversionOptions);
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(file) {
            currentFile = file;
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            displayFileInfo(file);
            
            // æ£€æµ‹æ–‡ä»¶æ ¼å¼
            const detectedFormat = detectFileFormat(file.name);
            if (detectedFormat) {
                document.getElementById('sourceFormat').value = detectedFormat;
            }
            
            // æ˜¾ç¤ºè½¬æ¢é€‰é¡¹
            document.getElementById('conversionSection').style.display = 'block';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateConvertButton();
            
            // ç¡®ä¿ FFmpeg å·²åŠ è½½
            if (!isFFmpegLoaded) {
                await loadFFmpeg();
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            const lastModified = new Date(file.lastModified).toLocaleString();
            
            fileDetails.innerHTML = `
                <div class="file-detail">
                    <div class="file-detail-label">æ–‡ä»¶å</div>
                    <div class="file-detail-value">${file.name}</div>
                </div>
                <div class="file-detail">
                    <div class="file-detail-label">æ–‡ä»¶å¤§å°</div>
                    <div class="file-detail-value">${sizeInMB} MB</div>
                </div>
                <div class="file-detail">
                    <div class="file-detail-label">æ–‡ä»¶ç±»å‹</div>
                    <div class="file-detail-value">${file.type || 'æœªçŸ¥'}</div>
                </div>
                <div class="file-detail">
                    <div class="file-detail-label">ä¿®æ”¹æ—¶é—´</div>
                    <div class="file-detail-value">${lastModified}</div>
                </div>
            `;
            
            fileInfo.style.display = 'block';
        }

        // æ£€æµ‹æ–‡ä»¶æ ¼å¼
        function detectFileFormat(filename) {
            const extension = filename.toLowerCase().split('.').pop();
            return extension;
        }

        // åŠ è½½ FFmpeg
        async function loadFFmpeg() {
            try {
                showProgress('æ­£åœ¨åŠ è½½ FFmpeg æ ¸å¿ƒæ–‡ä»¶ (~31MB)...', 0);
                
                ffmpeg = new FFmpeg();
                
                ffmpeg.on('log', ({ message }) => {
                    console.log(message);
                    appendLog(message);
                });
                
                ffmpeg.on('progress', ({ progress, time }) => {
                    const percentage = Math.round(progress * 100);
                    updateProgress(`è½¬æ¢ä¸­... ${percentage}%`, percentage);
                });

                // ä½¿ç”¨é‡è¯•æœºåˆ¶åŠ è½½å¤§æ–‡ä»¶
                await loadWithRetry();
                
                isFFmpegLoaded = true;
                hideProgress();
                updateConvertButton();
                showSuccess('FFmpeg åŠ è½½å®Œæˆï¼');
            } catch (error) {
                console.error('FFmpeg åŠ è½½å¤±è´¥:', error);
                showError('FFmpeg åŠ è½½å¤±è´¥: ' + error.message + ' - æ­£åœ¨å°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
                
                // å°è¯•å¤‡ç”¨åŠ è½½æ–¹æ¡ˆ
                try {
                    await loadFFmpegFallback();
                    // ç¡®ä¿çŠ¶æ€æ­£ç¡®æ›´æ–°
                    isFFmpegLoaded = true;
                    hideProgress();
                    updateConvertButton();
                    showSuccess('FFmpeg åŠ è½½å®Œæˆï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰ï¼');
                } catch (fallbackError) {
                    console.error('å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                    isFFmpegLoaded = false;
                    hideProgress();
                    showError('FFmpeg åŠ è½½å¤±è´¥ï¼Œæ–‡ä»¶è¾ƒå¤§(31MB)ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚å»ºè®®ä½¿ç”¨ç¨³å®šçš„ç½‘ç»œç¯å¢ƒã€‚');
                }
            }
        }

        // å¸¦é‡è¯•çš„åŠ è½½å‡½æ•°
        async function loadWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    updateProgress(`æ­£åœ¨åŠ è½½ FFmpeg (å°è¯• ${attempt}/${maxRetries})...`, (attempt - 1) * 10);
                    
                    const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
                    
                    // ä½¿ç”¨è¶…æ—¶æ§åˆ¶
                    const loadPromise = ffmpeg.load({
                        coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                        wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                    });
                    
                    // è®¾ç½®è¶…æ—¶ (60ç§’)
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')), 60000);
                    });
                    
                    await Promise.race([loadPromise, timeoutPromise]);
                    
                    // å¦‚æœæˆåŠŸï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                    console.log(`FFmpeg åŠ è½½æˆåŠŸ (å°è¯• ${attempt})`);
                    return;
                    
                } catch (error) {
                    console.warn(`åŠ è½½å°è¯• ${attempt} å¤±è´¥:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // ç­‰å¾…åé‡è¯•
                    updateProgress(`åŠ è½½å¤±è´¥ï¼Œ${2}ç§’åé‡è¯•...`, attempt * 20);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        // å¤‡ç”¨åŠ è½½æ–¹æ¡ˆ
        async function loadFFmpegFallback() {
            showProgress('æ­£åœ¨å°è¯•å¤‡ç”¨åŠ è½½æ–¹æ¡ˆ...', 0);
            
            // å°è¯•å¤šä¸ª CDN æºå’Œç‰ˆæœ¬
            const cdnOptions = [
                {
                    name: 'jsDelivr CDN (0.12.6)',
                    url: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd',
                },
                {
                    name: 'unpkg CDN (0.12.4)',
                    url: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd',
                },
                {
                    name: 'jsDelivr CDN (0.12.4)', 
                    url: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/umd',
                },
                {
                    name: 'jsDelivr CDN (0.11.0 - è½»é‡ç‰ˆ)',
                    url: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/umd',
                }
            ];
            
            for (let i = 0; i < cdnOptions.length; i++) {
                try {
                    const option = cdnOptions[i];
                    showProgress(`æ­£åœ¨å°è¯• ${option.name} (${i + 1}/${cdnOptions.length})...`, (i / cdnOptions.length) * 80);
                    
                    // ä¸ºæ¯ä¸ªCDNä¹Ÿæ·»åŠ è¶…æ—¶å’Œé‡è¯•
                    await loadFromCDNWithTimeout(option.url, 45000); // 45ç§’è¶…æ—¶
                    
                    console.log(`FFmpeg é€šè¿‡ ${option.name} åŠ è½½æˆåŠŸ`);
                    return;
                } catch (error) {
                    console.warn(`${cdnOptions[i].name} å¤±è´¥:`, error.message);
                    if (i === cdnOptions.length - 1) {
                        throw error;
                    }
                    
                    // çŸ­æš‚ç­‰å¾…åå°è¯•ä¸‹ä¸€ä¸ªCDN
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        // ä»æŒ‡å®šCDNåŠ è½½ï¼Œå¸¦è¶…æ—¶æ§åˆ¶
        async function loadFromCDNWithTimeout(baseURL, timeout = 45000) {
            const loadPromise = ffmpeg.load({
                coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
            });
            
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error(`CDN åŠ è½½è¶…æ—¶ (${timeout/1000}ç§’)`)), timeout);
            });
            
            return Promise.race([loadPromise, timeoutPromise]);
        }

        // å¡«å……æ ¼å¼é€‰æ‹©å™¨
        function populateFormatSelectors() {
            const targetFormat = document.getElementById('targetFormat');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            targetFormat.innerHTML = '<option value="">è¯·é€‰æ‹©æ ¼å¼</option>';
            
            // æ·»åŠ æ‰€æœ‰æ”¯æŒçš„æ ¼å¼
            Object.values(supportedFormats).forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category.name;
                
                category.formats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format.toUpperCase();
                    optgroup.appendChild(option);
                });
                
                targetFormat.appendChild(optgroup);
            });
        }

        // æ›´æ–°è½¬æ¢é€‰é¡¹
        function updateConversionOptions() {
            const targetFormat = document.getElementById('targetFormat').value;
            const isVideo = supportedFormats.video.formats.includes(targetFormat);
            const isAudio = supportedFormats.audio.formats.includes(targetFormat);
            
            // æ ¹æ®ç›®æ ‡æ ¼å¼æ˜¾ç¤º/éšè—ç›¸å…³é€‰é¡¹
            document.getElementById('resolution').parentElement.style.display = isVideo ? 'block' : 'none';
            document.getElementById('fps').parentElement.style.display = isVideo ? 'block' : 'none';
            
            // æ›´æ–°è½¬æ¢æŒ‰é’®çŠ¶æ€
            updateConvertButton();
        }

        // æ›´æ–°è½¬æ¢æŒ‰é’®çŠ¶æ€
        function updateConvertButton() {
            const convertBtn = document.getElementById('convertBtn');
            const hasFile = !!currentFile;
            const hasTargetFormat = !!document.getElementById('targetFormat').value;
            const canConvert = hasFile && isFFmpegLoaded && hasTargetFormat;
            
            convertBtn.disabled = !canConvert;
            
            if (!hasFile) {
                convertBtn.textContent = 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶';
            } else if (!isFFmpegLoaded) {
                convertBtn.textContent = 'FFmpeg åŠ è½½ä¸­...';
            } else if (!hasTargetFormat) {
                convertBtn.textContent = 'è¯·é€‰æ‹©ç›®æ ‡æ ¼å¼';
            } else {
                convertBtn.textContent = 'å¼€å§‹è½¬æ¢';
            }
            
            console.log('æŒ‰é’®çŠ¶æ€æ›´æ–°:', { hasFile, isFFmpegLoaded, hasTargetFormat, canConvert });
        }

        // å¼€å§‹è½¬æ¢
        async function startConversion() {
            console.log('å¼€å§‹è½¬æ¢æ£€æŸ¥:', { 
                hasFile: !!currentFile, 
                isLoaded: isFFmpegLoaded, 
                ffmpegInstance: !!ffmpeg 
            });
            
            if (!currentFile) {
                showError('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            if (!isFFmpegLoaded) {
                showError('FFmpeg å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™...');
                // å¦‚æœè¿˜æ²¡åŠ è½½ï¼Œå°è¯•åŠ è½½
                if (!ffmpeg) {
                    await loadFFmpeg();
                }
                return;
            }
            
            const targetFormat = document.getElementById('targetFormat').value;
            if (!targetFormat) {
                showError('è¯·é€‰æ‹©ç›®æ ‡æ ¼å¼');
                return;
            }
            
            try {
                // ç¦ç”¨è½¬æ¢æŒ‰é’®
                document.getElementById('convertBtn').disabled = true;
                
                // æ˜¾ç¤ºè¿›åº¦
                showProgress('æ­£åœ¨å‡†å¤‡è½¬æ¢...', 0);
                
                // å†™å…¥è¾“å…¥æ–‡ä»¶
                const inputFileName = `input.${detectFileFormat(currentFile.name)}`;
                const outputFileName = `output.${targetFormat}`;
                
                await ffmpeg.writeFile(inputFileName, await fetchFile(currentFile));
                
                // æ„å»º FFmpeg å‘½ä»¤
                const command = buildFFmpegCommand(inputFileName, outputFileName);
                
                showProgress('æ­£åœ¨è½¬æ¢æ–‡ä»¶...', 10);
                
                // æ‰§è¡Œè½¬æ¢
                await ffmpeg.exec(command);
                
                // è¯»å–è¾“å‡ºæ–‡ä»¶
                const data = await ffmpeg.readFile(outputFileName);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([data.buffer], { type: getMimeType(targetFormat) });
                const url = URL.createObjectURL(blob);
                
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = url;
                downloadBtn.download = `converted.${targetFormat}`;
                
                // æ˜¾ç¤ºç»“æœ
                hideProgress();
                document.getElementById('resultSection').style.display = 'block';
                showSuccess('è½¬æ¢å®Œæˆï¼');
                
            } catch (error) {
                console.error('è½¬æ¢å¤±è´¥:', error);
                showError('è½¬æ¢å¤±è´¥: ' + error.message);
                hideProgress();
            } finally {
                document.getElementById('convertBtn').disabled = false;
            }
        }

        // æ„å»º FFmpeg å‘½ä»¤
        function buildFFmpegCommand(inputFile, outputFile) {
            const command = ['-i', inputFile];
            
            // è´¨é‡è®¾ç½®
            const quality = document.getElementById('quality').value;
            const bitrate = document.getElementById('bitrate').value;
            const resolution = document.getElementById('resolution').value;
            const fps = document.getElementById('fps').value;
            
            // æ·»åŠ è´¨é‡å‚æ•°
            if (quality === 'high') {
                command.push('-crf', '18');
            } else if (quality === 'medium') {
                command.push('-crf', '23');
            } else if (quality === 'low') {
                command.push('-crf', '28');
            }
            
            // æ·»åŠ æ¯”ç‰¹ç‡
            if (bitrate) {
                command.push('-b:v', `${bitrate}k`);
            }
            
            // æ·»åŠ åˆ†è¾¨ç‡
            if (resolution) {
                command.push('-s', resolution);
            }
            
            // æ·»åŠ å¸§ç‡
            if (fps) {
                command.push('-r', fps);
            }
            
            // è¾“å‡ºæ–‡ä»¶
            command.push(outputFile);
            
            return command;
        }

        // è·å– MIME ç±»å‹
        function getMimeType(format) {
            const mimeTypes = {
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'avi': 'video/avi',
                'mov': 'video/quicktime',
                'mp3': 'audio/mpeg',
                'wav': 'audio/wav',
                'ogg': 'audio/ogg',
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'webp': 'image/webp'
            };
            return mimeTypes[format] || 'application/octet-stream';
        }

        // æ¸²æŸ“æ”¯æŒçš„æ ¼å¼
        function renderSupportedFormats() {
            const container = document.getElementById('formatCategories');
            
            Object.values(supportedFormats).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'format-category';
                
                const title = document.createElement('h4');
                title.textContent = category.name;
                categoryDiv.appendChild(title);
                
                const formatList = document.createElement('div');
                formatList.className = 'format-list';
                
                category.formats.forEach(format => {
                    const tag = document.createElement('span');
                    tag.className = 'format-tag';
                    tag.textContent = format.toUpperCase();
                    formatList.appendChild(tag);
                });
                
                categoryDiv.appendChild(formatList);
                container.appendChild(categoryDiv);
            });
        }

        // è¿›åº¦å’ŒçŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function showProgress(text, percentage) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('logSection').style.display = 'block';
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function updateProgress(text, percentage) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
        }

        function showSuccess(message) {
            // å¯ä»¥æ·»åŠ æˆåŠŸæç¤ºçš„å®ç°
            console.log('Success:', message);
        }

        function appendLog(message) {
            const logSection = document.getElementById('logSection');
            logSection.textContent += message + '\n';
            logSection.scrollTop = logSection.scrollHeight;
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html> 